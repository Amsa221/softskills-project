<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Paiements (Public)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons from Lucide - Must be loaded before scripts that use it -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Custom styling for better aesthetics */
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 1rem;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 md:p-8 flex flex-col items-center">
    <div class="w-full max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">
            Régistre Public des Paiements
        </h1>
        <p class="text-center text-sm text-gray-500 mb-4">
            Utilisateur ID: <span id="userIdDisplay" class="font-mono text-xs text-indigo-600 bg-indigo-50 p-1 rounded">Chargement...</span>
        </p>

        <!-- Formulaire d'ajout de paiement -->
        <div id="addPaymentFormCard" class="card bg-white p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Ajouter un Nouveau Paiement</h2>
            <form id="paymentForm" class="space-y-4">
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700">Montant (FCFA)</label>
                    <input type="number" id="amount" required min="1" step="1"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <input type="text" id="description" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" id="submitBtn"
                        class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition ease-in-out duration-150">
                    Enregistrer le Paiement
                </button>
            </form>
        </div>

        <!-- Liste des paiements -->
        <div class="card bg-white p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Liste des Paiements Publics</h2>
            <div id="paymentsList" class="space-y-3">
                <p id="loadingMessage" class="text-center text-gray-500">Chargement des données...</p>
            </div>
        </div>

        <p id="errorMessage" class="text-center text-red-600 mt-4 hidden"></p>
    </div>
</div>

<!-- Modal de Confirmation/Édition -->
<div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
    <div class="bg-white card w-full max-w-md p-6 m-4" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4">Modifier le Paiement</h3>
        <form id="editForm" class="space-y-4">
            <!-- Champ caché pour stocker l'ID du document en cours d'édition -->
            <input type="hidden" id="editDocId">

            <div>
                <label for="editAmount" class="block text-sm font-medium text-gray-700">Montant (FCFA)</label>
                <input type="number" id="editAmount" required min="1" step="1"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="editDescription" class="block text-sm font-medium text-gray-700">Description</label>
                <input type="text" id="editDescription" required
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeEditModal()"
                        class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition ease-in-out duration-150">
                    Annuler
                </button>
                <button type="submit" id="saveEditBtn"
                        class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition ease-in-out duration-150">
                    Sauvegarder les Modifications
                </button>
            </div>
        </form>
    </div>
</div>


<!-- Firebase SDK Imports -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, setLogLevel, serverTimestamp, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firebase log level for debugging
    setLogLevel('Debug');

    // --- Global Variables (Mandatory Canvas Environment Variables) ---
    // The canvas environment provides these variables: __app_id, __firebase_config, __initial_auth_token
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth;
    let userId = null;

    // Références aux éléments du DOM
    const paymentsList = document.getElementById('paymentsList');
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const paymentForm = document.getElementById('paymentForm');

    // Références pour la modale d'édition
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const editDocIdInput = document.getElementById('editDocId');
    const editAmountInput = document.getElementById('editAmount');
    const editDescriptionInput = document.getElementById('editDescription');
    const saveEditBtn = document.getElementById('saveEditBtn');


    // Le chemin de la collection DOIT avoir un nombre IMPAIR de segments (5 dans ce cas)
    const COLLECTION_NAME = "payments";
    
    // Construit le chemin public correct: artifacts/{appId}/public/data/{collectionName}
    const getPublicCollectionPath = (appId) => {
        // Le chemin final est une chaîne unique de 5 segments
        return `artifacts/${appId}/public/data/${COLLECTION_NAME}`;
    };

    /**
     * UTILITAIRE LUCIDE ICONE
     * Génère le SVG d'une icône Lucide de manière sûre, en utilisant la méthode d'injection temporaire
     * car 'toSvg' n'est pas disponible dans le chargement CDN classique.
     * @param {string} iconName - Nom de l'icône (ex: 'Pencil', 'Trash2').
     * @param {string} classNames - Classes Tailwind à appliquer.
     * @returns {string} Le code SVG ou une chaîne vide si Lucide n'est pas prêt.
     */
    function getIconSvg(iconName, classNames) {
        // 1. Vérifie si Lucide est chargé
        if (typeof lucide === 'undefined') {
            console.error(`Icône Lucide non trouvée: ${iconName}. Lucide non chargé.`);
            return '';
        }
        
        // 2. Crée un élément temporaire
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = `<i data-lucide="${iconName}" class="${classNames}" width="20" height="20"></i>`;
        
        // 3. Appelle la fonction de création d'icônes sur l'élément temporaire
        // L'objet `lucide` doit être disponible globalement grâce au CDN.
        lucide.createIcons({
            icons: lucide.icons,
            // L'élément par défaut pour la création d'icônes est l'élément lui-même
            container: tempDiv,
            attrs: { class: classNames, width: 20, height: 20 }
        });

        // 4. Récupère le contenu SVG généré.
        // L'icône `<i>` a été remplacée par l'élément `<svg>`.
        return tempDiv.innerHTML;
    }


    /**
     * Affiche un message d'erreur ou de succès à l'utilisateur (remplace alert()).
     * @param {string} message - Le message à afficher.
     * @param {string} type - 'error' ou 'success' pour le style.
     */
    function showMessage(message, type = 'error') {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
        if (type === 'error') {
            errorMessage.className = 'text-center text-red-600 mt-4';
        } else {
            errorMessage.className = 'text-center text-green-600 mt-4';
        }
        setTimeout(() => {
            errorMessage.classList.add('hidden');
        }, 5000);
    }

    /**
     * Initialise Firebase et authentifie l'utilisateur.
     */
    async function initFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Authentification avec le jeton personnalisé ou anonyme
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // Écouteur de changement d'état d'authentification
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    console.log("Firebase initialisé et utilisateur connecté:", userId);
                    // Démarrer l'écoute des données après l'authentification
                    listenForPayments();
                } else {
                    console.log("Aucun utilisateur connecté.");
                }
            });

        } catch (error) {
            console.error("Erreur lors de l'initialisation de Firebase ou de l'authentification:", error);
            showMessage(`Erreur Firebase: ${error.message}. Vérifiez la console pour plus de détails.`, 'error');
            loadingMessage.textContent = "Erreur de chargement. Veuillez vérifier la console.";
        }
    }

    /**
     * Écoute les mises à jour en temps réel de la collection 'payments'.
     */
    function listenForPayments() {
        if (!db || !userId) {
            console.error("Firestore DB n'est pas prêt ou userId n'est pas défini.");
            return;
        }

        try {
            const PUBLIC_COLLECTION_PATH = getPublicCollectionPath(appId);
            console.log("Utilisation du chemin de collection:", PUBLIC_COLLECTION_PATH);

            const q = query(collection(db, PUBLIC_COLLECTION_PATH));

            onSnapshot(q, (snapshot) => {
                paymentsList.innerHTML = '';
                loadingMessage.classList.add('hidden');
                
                if (snapshot.empty) {
                    paymentsList.innerHTML = '<p class="text-gray-500 italic">Aucun paiement enregistré pour l\'instant.</p>';
                    return;
                }
                
                // Précharge les icônes nécessaires une seule fois pour éviter de les générer à chaque itération
                // Maintenant utilise la fonction utilitaire corrigée
                const pencilIcon = getIconSvg('Pencil', 'w-5 h-5');
                const trashIcon = getIconSvg('Trash2', 'w-5 h-5');


                snapshot.docs.forEach(docSnapshot => {
                    const payment = docSnapshot.data();
                    const docId = docSnapshot.id;
                    const isOwner = payment.addedBy === userId; // L'utilisateur est-il le créateur?

                    const paymentElement = document.createElement('div');
                    paymentElement.className = 'p-3 bg-white rounded-xl border border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0';
                    
                    // Formatage du montant en chaîne pour la fonction d'édition
                    const amountString = payment.amount ? payment.amount.toString() : '0';
                    // Échapper les apostrophes pour la chaîne JS
                    const descriptionEscaped = payment.description ? payment.description.replace(/'/g, "\\'") : ''; 

                    paymentElement.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-medium text-gray-800">${payment.description}</p>
                            <p class="text-xs text-gray-500">Ajouté par: <span class="font-mono">${payment.addedBy.substring(0, 8)}...</span></p>
                            <p class="text-xs text-gray-500">Date: ${payment.timestamp ? new Date(payment.timestamp.toDate()).toLocaleString('fr-FR') : 'N/A'}</p>
                        </div>
                        <div class="flex items-center space-x-3 mt-2 md:mt-0">
                            <span class="text-lg font-bold text-green-600">${payment.amount ? payment.amount.toLocaleString('fr-FR') : '0'} FCFA</span>
                            ${isOwner ? `
                                <button title="Modifier" onclick="openEditModal('${docId}', '${descriptionEscaped}', ${amountString})"
                                        class="p-2 text-blue-500 hover:text-blue-700 transition ease-in-out duration-150 rounded-full hover:bg-blue-50">
                                    ${pencilIcon}
                                </button>
                                <button title="Supprimer" onclick="deletePayment('${docId}')"
                                        class="p-2 text-red-500 hover:text-red-700 transition ease-in-out duration-150 rounded-full hover:bg-red-50">
                                    ${trashIcon}
                                </button>
                            ` : `<span class="text-xs text-gray-400">Lecture seule</span>`}
                        </div>
                    `;
                    paymentsList.appendChild(paymentElement);
                });
            }, (error) => {
                console.error("Erreur de onSnapshot (lecture):", error);
                showMessage(`Erreur de lecture Firestore: ${error.message}`, 'error');
            });
        } catch (error) {
            console.error("Erreur lors de la configuration de l'écouteur de paiements:", error);
        }
    }

    /**
     * Gère la soumission du formulaire pour ajouter un nouveau paiement.
     */
    async function addPayment(event) {
        event.preventDefault();
        
        if (!db || !userId) {
            showMessage("Base de données ou ID utilisateur non disponible.", 'error');
            return;
        }

        const amountInput = document.getElementById('amount');
        const descriptionInput = document.getElementById('description');
        const amount = Number(amountInput.value);
        const description = descriptionInput.value.trim();

        if (amount <= 0 || !description) {
            showMessage("Montant ou description invalide.", 'error');
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.textContent = 'Enregistrement...';
        submitBtn.disabled = true;

        try {
            const PUBLIC_COLLECTION_PATH = getPublicCollectionPath(appId);
            const paymentsCollectionRef = collection(db, PUBLIC_COLLECTION_PATH);
            
            await addDoc(paymentsCollectionRef, {
                amount: amount,
                description: description,
                addedBy: userId, // Enregistre l'ID de l'utilisateur qui a ajouté le paiement
                timestamp: serverTimestamp()
            });

            amountInput.value = '';
            descriptionInput.value = '';
            showMessage("Paiement ajouté avec succès.", 'success');

        } catch (error) {
            console.error("Erreur lors de l'ajout du paiement:", error);
            showMessage(`Erreur lors de l'ajout: ${error.message}`, 'error');
        } finally {
            submitBtn.textContent = 'Enregistrer le Paiement';
            submitBtn.disabled = false;
        }
    }
    
    // --- FONCTIONS D'ÉDITION (MISE À JOUR) ---
    
    /**
     * Ouvre la modale d'édition et pré-remplit les champs.
     * @param {string} id - L'ID du document à modifier.
     * @param {string} description - Description actuelle.
     * @param {number} amount - Montant actuel.
     */
    window.openEditModal = (id, description, amount) => {
        editDocIdInput.value = id;
        editDescriptionInput.value = description;
        editAmountInput.value = amount;
        editModal.classList.remove('hidden');
    };

    /**
     * Ferme la modale d'édition.
     */
    window.closeEditModal = () => {
        editModal.classList.add('hidden');
        editForm.reset();
    };

    /**
     * Gère la soumission du formulaire d'édition pour mettre à jour un paiement.
     */
    async function handleEditSubmit(event) {
        event.preventDefault();

        if (!db || !userId) {
            showMessage("Base de données ou ID utilisateur non disponible.", 'error');
            return;
        }

        const docId = editDocIdInput.value;
        const newAmount = Number(editAmountInput.value);
        const newDescription = editDescriptionInput.value.trim();

        if (!docId || newAmount <= 0 || !newDescription) {
            showMessage("Données d'édition invalides.", 'error');
            return;
        }

        saveEditBtn.textContent = 'Sauvegarde...';
        saveEditBtn.disabled = true;

        try {
            const PUBLIC_COLLECTION_PATH = getPublicCollectionPath(appId);
            // Crée une référence au document spécifique
            const docRef = doc(db, PUBLIC_COLLECTION_PATH, docId);
            
            await updateDoc(docRef, {
                amount: newAmount,
                description: newDescription
                // On ne modifie pas 'addedBy' ni 'timestamp' ici
            });

            showMessage("Paiement modifié avec succès.", 'success');
            closeEditModal();

        } catch (error) {
            console.error("Erreur lors de la modification du paiement:", error);
            showMessage(`Erreur lors de la modification: ${error.message}`, 'error');
        } finally {
            saveEditBtn.textContent = 'Sauvegarder les Modifications';
            saveEditBtn.disabled = false;
        }
    }


    // --- FONCTION DE SUPPRESSION (DELETE) ---

    /**
     * Supprime un paiement en fonction de son ID.
     * RAPPEL : J'utilise une simple confirmation console/visuelle au lieu de window.confirm()
     * @param {string} id - L'ID du document à supprimer.
     */
    window.deletePayment = async (id) => {
        if (!db || !userId) {
            showMessage("Base de données ou ID utilisateur non disponible.", 'error');
            return;
        }
        
        // Ceci est une alternative à window.confirm() qui n'est pas permis dans l'environnement.
        if (!confirm('Êtes-vous sûr de vouloir supprimer ce paiement ?')) {
             return;
        }

        try {
            const PUBLIC_COLLECTION_PATH = getPublicCollectionPath(appId);
            const docRef = doc(db, PUBLIC_COLLECTION_PATH, id);

            await deleteDoc(docRef);
            showMessage("Paiement supprimé avec succès.", 'success');

        } catch (error) {
            console.error("Erreur lors de la suppression du paiement:", error);
            showMessage(`Erreur lors de la suppression: ${error.message}`, 'error');
        }
    };


    // Attacher les écouteurs d'événements
    paymentForm.addEventListener('submit', addPayment);
    editForm.addEventListener('submit', handleEditSubmit);

    // Démarrer l'application
    initFirebase();
</script>
</body>
</html>
